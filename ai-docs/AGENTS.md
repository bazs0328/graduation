# AGENTS.md
# AI Agent 行为规范（必读）

本项目使用 AI Agent（如 Codex）作为工程协作者。
所有 Agent 在参与本项目开发时，必须严格遵守以下规则。

---

## 一、项目目标（最高优先级）

本项目的目标是：

**构建一个真实可用的学习辅助系统，而不是演示系统或研究原型。**

优先级顺序如下（从高到低）：
1. 系统可用性
2. 行为可预测性
3. 用户体验
4. 代码可维护性（可读/可测试/可复现）
5. 代码优雅性
6. 算法复杂度

---

## 二、必读文档与优先级（强制）

Agent 在开始任何工作前，必须先阅读并遵守以下文件：

1) `ai-docs/CURRENT.md`（最高优先级；若冲突以此为准）
2) `ai-docs/PROJECT.md`
3) `ai-docs/AGENTS.md`
4) `ai-docs/CONTEXT.md`
5) `ai-docs/TASKS.md`（任务队列；必须按此执行）
6) `ai-docs/PROMPTS.md`（交互模板；用于任务执行/报 bug/自检）

若上述文件缺失，Agent 必须先创建缺失文件或向用户说明缺失影响，并停止推进业务功能。

---

## 三、技术选型（禁止擅自更改）

未经明确指示，Agent 不得更改以下技术选型：

- 后端框架：FastAPI（Python）
- 数据库：MySQL
- ORM：SQLAlchemy + Alembic
- 向量检索：FAISS
- 架构原则：后端优先、API 驱动、服务层承载业务逻辑

禁止：
- 引入新的后端框架
- 擅自更换数据库或 ORM
- 进行大规模重构或“顺手优化”
- 引入新的外部依赖而不说明理由与影响范围

---

## 四、任务驱动开发规则（强制）

### 4.1 只能按 TASKS 执行
Agent 只能执行 `ai-docs/TASKS.md` 中明确列出的任务（按顺序，从第一条未完成开始）。
禁止：跳过队列、自行扩展需求、同时推进多个任务。

### 4.2 状态管理
每次开始执行某个任务时：
- 将该任务标记为 `[~] 进行中`
完成后：
- 将任务标记为 `[x] 已完成`
- 在任务下方追加“验证方式”（命令/脚本）或在 README/scripts 中提供可复现步骤

### 4.3 必须输出验收对照表
每完成一个任务，Agent 必须输出“验收对照表”，逐条对照该任务的验收项：
- 是否满足（是/否）
- 证据（命令输出摘要、curl 返回、截图文字等）

---

## 五、代码修改规则（非常重要）

Agent 在修改代码时必须遵守：

1) 修改范围最小化（最小可行实现优先）
2) 优先新增文件，而不是重写已有文件
3) 不得重构无关模块（禁止“顺手整理/抽象/改命名”）
4) 业务逻辑应下沉到 services，路由只做参数与调用编排
5) 每次修改后必须说明：
   - 改了什么（文件清单）
   - 为什么要改（目标对应哪个任务/验收项）
6) 必须给出可运行的验证方式（命令或接口）

---

## 六、验证与可复现（硬性门禁）

每次提交任何功能变更，Agent 必须至少完成以下验证之一，并给出命令与关键输出摘要：

- `scripts/dev_smoke.sh`（若存在，优先跑）
- `pytest`（若存在）
- 关键接口 curl 验证（至少覆盖本次任务新增/修改接口）

如果涉及数据库迁移（Alembic），必须额外验证：
- `alembic upgrade head` 成功
- 如本次迁移风险较大，应提供 `downgrade` 回滚验证（或说明为何无法回滚）

---

## 七、错误处理与稳定性

- 不得隐藏错误
- 不得静默失败
- 返回明确错误信息与合理状态码

建议状态码规范：
- 400：业务输入错误
- 404：资源不存在
- 409：前置条件不足（如索引未建/资料不足，无法生成测验）
- 422：参数校验错误
- 500：未捕获异常（应尽量避免）

稳定性优先于“智能表现”。

---

## 八、AI 使用原则（个性化必须可解释）

本项目中：

- 不进行模型训练
- 不使用黑箱学习者建模
- 所有“个性化”必须是**可解释、规则驱动的**
- 优先实现“可用闭环”，再做“更聪明”

如果某个方案需要训练模型或复杂 ML，请 **停止并询问**。

---

## 九、个性化与用户保护（强制要求）

在涉及测验、出题、学习引导时必须满足：

- 低水平用户不应直接遇到高难度题
- 必须考虑学习信心保护
- 默认策略应偏保守（易 → 难）
- 题目应尽量可追溯到资料片段（如 source_chunk_ids）

（具体难度配比与回调规则以 CURRENT.md/TASKS.md 为准）

---

## 十、何时必须询问用户（先问再做）

以下情况必须先询问，再行动：

- 引入新第三方库
- 大幅修改数据库结构（新增核心表/大量字段/破坏性改动）
- 调整难度控制或画像逻辑的核心规则
- 改变目录结构或做大规模重构
- 任何会影响可复现性/部署方式的改动（Docker、环境变量等）

---

## 十一、ai-docs 文件维护规则（允许交给 Agent，但有门禁）

### 11.1 允许 Agent 直接修改的文件
- ai-docs/CURRENT.md
- ai-docs/TASKS.md
- ai-docs/PROMPTS.md
- README / scripts/*

修改这些文件时必须：
- 在提交中说明“为什么改”
- 给出对应的验证方式（命令或脚本）

### 11.2 治理文件修改（必须先提案）
以下文件属于“项目宪法/身份”，Agent 不得直接改成既定事实：
- ai-docs/PROJECT.md
- ai-docs/AGENTS.md
- ai-docs/CONTEXT.md

如需修改，必须：
- 先输出变更提案（变更点 + 理由 + 风险）
- 等用户确认后再提交修改

### 11.3 推进阶段（更新 CURRENT.md）的门禁
Agent 只有在满足以下条件时，才允许更新 CURRENT.md 以推进到下一阶段：
- scripts/dev_smoke.sh 通过（若存在）
- pytest 通过（若存在）
- 若涉及迁移：alembic upgrade head 通过
- 重启服务后关键链路仍可用（至少：health + chat 或 quiz 闭环）

更新 CURRENT.md 时必须在同一提交中：
- 附上门禁命令与关键输出摘要
- 在 TASKS.md 中把已完成任务标记为 [x]

补充：如 `CURRENT.md` 与其他文件有冲突，以 `CURRENT.md` 为准。